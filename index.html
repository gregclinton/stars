<!--
    https://gregclinton.github.io/stars/
-->

<meta name="viewport" content="user-scalable=no,width=device-width" />

<div>
    <div id="name"></div>
    <div  id="time"></div>
    <div id="tilt"></div>
    <div id="stars"></div>
</div>

</body>

<link href="main.css" rel="stylesheet"/>
<script src="julian.js"></script>
<script src="location.js"></script>
<script src="sidereal.js"></script>
<script src="precess.js"></script>

<script>
    const stars = document.getElementById('stars');

    [
        ['η Oph', '17 10 23', '-15 43'],
        ['π Her', '17 15 03', '36 49'],
    ].forEach((star, i) => {
        if (i > 0) {
            const bar = document.createElement('span');
            bar.innerHTML = ' | ';
            stars.appendChild(bar);
        }
        const node = document.createElement('span');
        node.innerHTML = star[0];
        node.setAttribute('onclick', 'explore("' + star[0] + '","' + star[1] + '","' + star[2] + '")');
        stars.appendChild(node);
    });

    const floor = Math.floor;
    let targetTime = false;
    let targetTilt = false;

    function put(name, value) {
        document.getElementById(name).innerHTML = value;
    }

    function explore(name, ra, dec) {
        getGeoLocation((latitude, longitude) => {
            const decParts = dec.split(' ');
            const raParts = ra.split(' ');
            const [raPrecessed, decPrecessed] = precess(
                15 * (1 * raParts[0] + raParts[1] / 60 + raParts[2] / 3600),
                1 * decParts[0] + decParts[1] / 60
            );

            // https://astronomy.stackexchange.com/questions/29471/how-to-convert-sidereal-time-to-local-time
            const t = new Date();
            const lst = localSiderealDegrees(t, longitude);
            const diff = raPrecessed + (lst > raPrecessed ? 360 : 0) - lst;

            targetTime = new Date(t.getTime() + 240000 * diff / 1.0027379);
            targetTilt = 90 - Math.abs(decPrecessed - latitude);

            put('name', name);
            put('time', '');
        });
    }

    window.addEventListener('deviceorientation', e => {
        if (targetTilt) {
            const tilt = Math.abs(targetTilt - e.beta);
            put('tilt', tilt > 1 ? floor(tilt) : tilt < 0.25 ? 0 : 1);
        }
    });

    setInterval(() => {
        if (targetTime) {
            const pad = n => (n < 10 ? '0' : '') + n;
            const t = floor(Math.abs(targetTime - new Date()) / 1000);
            const seconds = t % 60;
            const minutes = floor(t / 60) % 60;
            const hours = floor(t / 60 / 60);

            put('time', hours + ':' + pad(minutes) + ':' + pad(seconds));
        }
    }, 1000);
</script>