<!--
    https://gregclinton.github.io/stars/
-->

<div>
    <div id="name"></div>
    <div id="time"></div>
    <div id="tilt"></div>
    <div id="stars">
        <div onclick="explore('η Oph', '17:10:23', '-15 43')">η Oph</div>
    </div>
</div>

</body>

<link href="main.css" rel="stylesheet"/>
<script src="julian.js"></script>
<script src="location.js"></script>
<script src="sidereal.js"></script>
<script src="precess.js"></script>

<script>
    function addStars() {
        const div = document.getElementById('stars');

        const stars = [
            ['η Oph', '17:10:23', '-15 43']
        ].forEach(star => {
            const node = document.createElement('div');
            node.innerHTML = star[0];
            node.setAttribute('onclick', 'explore("' + star[0] + '","' + star[1] + '","' + star[2] + '")');
            div.appendChild(node);
        });
    }
    addStars();

    const floor = Math.floor;
    let targetTime = false;
    let targetTilt = false;

    function put(name, value) {
        document.getElementById(name).innerHTML = value;
    }

    function explore(name, ra, dec) {
        getGeoLocation((latitude, longitude) => {
            const decParts = ra.split(' ');
            const raParts = dec.split(':');
            const [raPrecessed, decPrecessed] = precess(
                1 * decParts[0] + decParts[1] / 60,
                15 * (1 * raParts[0] + raParts[1] / 60 + raParts[2] / 3600)
            );

            targetTime = new Date();

            while (Math.abs(localSiderealDegrees(targetTime, longitude) - raPrecessed) > 0.01) {
                targetTime = new Date(targetTime.getTime() + 1000);
            }

            targetTilt = decPrecessed + latitude;
            put('name', name);
        });
    }

    window.addEventListener('deviceorientation', e => {
        if (targetTilt) {
            const degrees = e.beta + (Math.abs(e.beta) < 5 ? 90 : 0);
            const diff = Math.abs(degrees - targetTilt);
            const direction = degrees < targetTilt ? 'down' : 'up';

            put('tilt', diff > 10 ? '' : diff < 0.25 ? 'perfect' :
                (direction + ' ' + (diff < 0.5 ? 'a smidge' : diff < 1 ? 'a half' : floor(diff))));
        }
    });

    setInterval(() => {
        if (targetTime) {
            const pad = n => (n < 10 ? '0' : '') + n;
            const t = floor(Math.abs(targetTime - new Date()) / 1000);
            const seconds = t % 60;
            const minutes = floor(t / 60) % 60;
            const hours = floor(t / 24);

            put('time', hours + ':' + pad(minutes) + ':' + pad(seconds));
        }
    }, 1000);
</script>